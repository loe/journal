<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Rails Stack &mdash; W. Andrew Loe III: Journal</title>
  <meta name="author" content="W. Andrew Loe III" />
  <meta name="generator" content="jekyll" />
 
  <link rel="stylesheet" href="http://assets.andrewloe.com/css/journal.css" type="text/css" media="screen, projection">
  <link rel="stylesheet" href="http://assets.andrewloe.com/css/syntax.css" type="text/css" media="screen, projection">
 
  <link href="http://feeds.andrewloe.com/WALoeIII-Journal" rel="alternate" title="W. Andrew Loe III's Atom Feed" type="application/atom+xml" />
  
  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1702281-1']);
    _gaq.push(['_setDomainName', '.andrewloe.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

  </script>
</head>
<body>
<div id="nav">
  <h1><a href="/">W. Andrew Loe III: Journal</a></h1>

  <ul>
    <li><a href="/archive/">Archive</a></li>
    <li><a href="/about/">About</a></li>
    <li><a href="http://feeds.andrewloe.com/WALoeIII-Journal">Feed</a></li>
  </ul>

  <h3>search</h3>
  <form method="get" action="http://www.google.com/search">
    <input type="text" id="search" class="ti" name="q" value="" />
    <input type="hidden" name="q" value="site:journal.andrewloe.com" />
    <input type="submit" value="Search" />
  </form>

  <h3>about me</h3>
  <p>I am a web developer at 
    <a href="http://onehub.com">Onehub</a>. I like sailing, snowboarding, and computers.</p>

    <h3>more me</h3>

    <ul>
      <li>
        <a href="http://gallery.andrewloe.com/">
          gallery
        </a>
      </li>
      <li>
        <a href="http://github.com/loe">
          github
        </a>
      </li>
      <li>
        <a href="http://twitter.com/WALoeIII">
          Twitter 
        </a>
      </li>
      <li>
        <a href="http://www.facebook.com/WALoeIII">
          Facebook
          </a>
      </li>
      <li>
      <a href="http://www.linkedin.com/in/WALoeIII">
        LinkedIn
        </a>
      </li>
      <li>
        <a href="http://onehub.com/">
          Onehub
          <span>File Transfer and Online Collaboration!</span>
        </a>
      </li>
      <li>
        <a href="mailto:andrew@andrewloe.com">
          Email
        </a>
      </li>
    </ul>

</div>

<div id="content">

  <div class="post">

    <h2>Rails Stack</h2>

    <p class="pubdate">Posted on Friday, March 28, 2008</p>

    h2. Linux, "MySQL":http://mysql.com/, "nginx":http://nginx.net/, "Mongrel":http://mongrel.rubyforge.com/ , "Rails":http://rubyonrails.org/, and friends.

h2. Big Picture:

An ideal setup uses two different servers or virtual machines to split up the load and facilitate scaling. The first machine runs nginx serving static content and acting as a reverse proxy passing dynamic requests to a pool of mongrels running the rails application. The second machine is a dedicated MySQL database server. Even if you only have one physical box, two virtual machines (Xen based) is preferred, it is easier to scale and doesn't require as much memory context switching. Our host, Engine Yard, uses a similar setup based on Gentoo and Xen.

h2. Linux Setup:

All of the tools and applications used in this stack are actively developed and available in most package management systems. This document will assume you use Debian/GNU Linux, but will work equally well on Ubuntu. If choose to use Fedora, Gentoo or another distribution, you will need substitute commands for your package-management tool.

Installing and configuring Linux is outside the scope of this document, but you should strive for a minimalist system based on a recent release of the 2.6 kernel. Debian and Ubuntu both offer a number of "pre-made" configurations in their installers, just avoid installing anything more than the base system as it will just add more software that you will have to disable or remove later.

h2. Conventions:

@$@ indicates a standard shell prompt.

@#@ indicates the command needs to be run as the root user, either by switching to the root user account or assuming root privileges with a tool like @sudo@.

h2. Tools:

While installing and managing a Linux server, you will often need the power of the root account. However, because the root user is so powerful, it dangerous to use all the time. A better solution is to use a standard user account and only assume the privileges of the root user when necessary. Sudo was designed to do exactly this.

@# apt-get install sudo@

Once the package is installed, the list of users able to assume root powers is controlled by @/etc/sudoers@. This file must be edited with the @visudo@ command, which will open your default editor (or vi if your shell does not have an editor set).

@# visudo@

If you are unfamiliar with vi, press 'i' to put it in insert mode, then add a line to enable your user.

@username	ALL=(ALL) ALL@

You can read more on the sudo package to better understand this configuration file. Once you have completed your edit, press escape (ESC) to exit editor mode. To save the file type ':' to enter command mode and then type 'w' and 'q' (meaning write and quit). The file should be properly saved and your user will now be able to assume root privileges.

h2. Database Server:

MySQL is our database of choice, it is popular in the Rails community, proven to scale, and fast (especially in a read heavy environment).

To install, use the mysql-server package.

@# apt-get install mysql-server@

Your package manager should handle all the dependencies, including the mysql-client package, which we will use to improve our Ruby to MySQL performance. The installer may prompt you for a few questions, aim to accept the defaults and enter in information specific to your server.

h3. Database Configuration:

The configuration file for MySQL is usually located in @/etc/mysql as my.cnf@. Most MySQL packages also include a number of other simple configurations to help MySQL perform better. Take a look at @my-large.cnf@ and @my-small.cnf@ in @/usr/share/mysql@ and update your @/etc/mysql/my.cnf@ to reflect your hardware or virtual machine's configuration. MySQL tuning is a complex subject, but some basic configuration can go a long way to helping the application to perform well.

Before adding any databases, it is also important to instruct MySQL to use more international character encodings and collations. Storing the data in this way will make internationalization a simpler task in the future.

In @/etc/mysql/my.cnf@:

<div class="highlight"><pre><code class="text">[client]
default-character-set = utf8

[server]
default-character-set = utf8
default-collation = utf8_general_ci
</code></pre>
</div>

These directives instruct MySQL to use UTF-8 for everything. If you have not already, restart your database server.

@# /etc/init.d/mysql restart@

You can now add the database to the server.

@$ mysqladmin -u root create database_name@

Consult the MySQL documentation to change the root user's password and to add a user with privileges on the specific database. It may be simpler to use a MySQL administration GUI to achieve these tasks.

h2. Application Server

The application server requires the most complex setup.

h3. Ruby & Ruby Gems

To start, you will need "Ruby":http://www.ruby-lang.org/ and "Ruby Gems":http://www.ruby-lang.org/.

@# apt-get install ruby rubygems@

@ruby@ is a transitional package, currently it will install Ruby 1.8.6 (as of March 20, 2008), unless you know of a specific feature or bug to avoid, it is simplest to let the the package-management system handle which version you get. "Ruby Gems":http://rubyforge.org/projects/rubygems/ is a package management system for system for third party ruby libraries, it functions much like "CPAN":http://www.cpan.org/ for "Perl":http://www.perl.com/ or "PEAR":http://www.perl.com/ for "PHP":http://php.net/. We're going to want a number of gems, but first lets update gems itself, from within itself -- how meta.

@# gem update --system@

Ruby gems should now download and recompile itself. Once that has completed, you can install the gems we'll need. The first one is a bit trickier than the others.

@# gem install mysql@

The @mysql@ gem provides fast C bindings between Ruby and MySQL, if you aren't already using these on your local machine you should give them a spin, the performance increase is well worth the minimal amount of effort required to install them. If you have your MySQL installed in a non-standard location, you may have to pass in @mysql_config@.

@# gem install mysql -- --with-mysql-config=/your/path/to/mysql_config@

With @mysql@ all setup and out of the way, its easy to install everything else you need.

@# gem install rails mongrel mongrel_cluster@

@rails@ is optional, you may choose to freeze rails inside your application, which would override this gem. @mongrel@ and @mongrel_cluster@ are the gems that provide us with our application server. Before diving into mongrel, there are a few more gems you may want that are entirely optional. 

@# gem install tmail swiftiply@

@tmail@ is an e-mail library, and is the same library that the @ActiveMailer@ component of Rails uses. Rails 2.0 now looks for this gem before loading its own bundled copy; by installing the gem you can get extra features and bug fixes that may have been released.

@swiftiply@ is a gem that patches mongrel to use the event based network programming model, commonly called "evented mongrels". You can find more on "Ezra Zygmuntowicz's Brainspl.at":http://brainspl.at/articles/2007/05/12/event-driven-mongrel-and-swiftiply-proxy and "my journal":http://journal.andrewloe.com/computers-and-technology where I did some "elementary benchmarking":http://journal.andrewloe.com/2007/5/22/mongrel-vs-evented-mongrel.

h3. Mongrel

"Mongrel":http://mongrel.rubyforge.org/ will serve as our application server, containing an instance of the Ruby interpreter and our Rails application.

bq. Mongrel is a fast HTTP library and server for Ruby that is intended for hosting Ruby web applications of any kind using plain HTTP rather than FastCGI or SCGI.

From inside your rails application you can start a mongrel server and interact with your application. By default, rails will start in development mode.

@$ mongrel_rails start@

A daemon with the application should now be running on port 3000. @ctrl+c@ to stop the server, lets move on to "mongrel_cluster":http://mongrel.rubyforge.org/wiki/MongrelCluster

h3. Mongrel Cluster

"Mongrel Cluster":http://mongrel.rubyforge.org/wiki/MongrelCluster will manage a pool of mongrels that nginx will reverse proxy requests to.

bq. Mongrel_cluster is a GemPlugin that wrappers the mongrel HTTP server and simplifies the deployment of webapps using a cluster of mongrel servers. Mongrel_cluster will conveniently configure and control several mongrel servers, or groups of mongrel servers, which are then load balanced using a reverse proxy solution.

The "wiki":http://mongrel.rubyforge.org/wiki/MongrelCluster has more extensive documentation, right now we will only look at the basics.

@# mongrel_rails cluster::configure -e production -p 8000 -N 3 -c /path/to/your/application -a 127.0.0.1 --user mongrel --group mongrel@

This line creates the file @application/path/config/mongrel_cluster.yml@. Most of the switches are self explanatory, @-a 127.0.0.1@ configures the IP that the server binds to, by making it local you make it impossible to hit a mongrel directly without passing through the proxy. @-p@ and @-N@ configure the start port and the number of mongrels to start, so 8000, 8001, and 8002 in this case. @--user@ and @--group@ are the system user and group the servers will run under; because the mongrels run on an unprivileged port, they may run as an unprivileged user to improve security. @-e@ is the environment our rails application will run in and @-c@ is the path to our application (mongrel cluster will look for its configuration file at this path + @config/mongrel_cluster.yml@, you may use @-C@ if you want to directly specify a YAML config file).

<div class="highlight"><pre><code class="yaml"><span class="nn">---</span> 
<span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mongrel</span>
<span class="l-Scalar-Plain">group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mongrel</span>
<span class="l-Scalar-Plain">cwd</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/path/to/my/application</span>
<span class="l-Scalar-Plain">address</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">127.0.0.1</span>
<span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="s">&quot;8000&quot;</span>
<span class="l-Scalar-Plain">servers</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
<span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">production</span>
<span class="l-Scalar-Plain">pid_file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">log/mongrel.pid</span>
</code></pre>
</div>

h3. Evented Mongrel

To use evented mongrels, you just need to pass an environmental variable @EVENT=1@ while starting your server. With @mongrel_cluster@ that will look like this:

@# EVENT=1 mongrel_rails cluster::start@

Don't forget to pass it even if you are just restarting the servers! At the top of the mongrel.log you should see it notify you that it is using events.

h2. Web Server

Currently our application server and web server are on the same virtual machine. In the future, we may choose to scale by moving the web server and static content to another virtual machine (or perhaps a CDN like Akamai) and have pure application servers. For now, we will keep things simple.

h3. nginx

"nginx":http://nginx.net/ is a very fast proxy that we will also use to serve our static content.

@# apt-get install nginx@

Configuration is very straight forward, everything is done in @/etc/nginx/nginx.conf@. The following configuration is based on "Ezra Zygmuntowicz's Brainspl.at" "nginx.conf":http://brainspl.at/nginx.conf.txt.

<div class="highlight"><pre><code class="nginx"><span class="c1"># user and group to run as</span>
<span class="k">user</span>  <span class="s">www-data</span> <span class="s">www-data</span><span class="p">;</span>

<span class="c1"># number of nginx workers</span>
<span class="k">worker_processes</span>  <span class="mi">3</span><span class="p">;</span>

<span class="c1"># pid of nginx master process</span>
<span class="k">pid</span> <span class="s">/var/run/nginx.pid</span><span class="p">;</span>

<span class="c1"># Number of worker connections. 1024 is a good default</span>
<span class="k">events</span> <span class="p">{</span>
  <span class="kn">worker_connections</span> <span class="mi">1024</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1"># start the http module where we config http access.</span>
<span class="k">http</span> <span class="p">{</span>
  <span class="c1"># pull in mime-types. You can break out your config </span>
  <span class="c1"># into as many include&#39;s as you want to make it cleaner</span>
  <span class="kn">include</span> <span class="s">/etc/nginx/mime.types</span><span class="p">;</span>

  <span class="c1"># set a default type for the rare situation that</span>
  <span class="c1"># nothing matches from the mimie-type include</span>
  <span class="kn">default_type</span>  <span class="s">application/octet-stream</span><span class="p">;</span>

  <span class="c1"># configure log format</span>
  <span class="kn">log_format</span> <span class="s">main</span> <span class="s">&#39;</span><span class="nv">$remote_addr</span> <span class="s">-</span> <span class="nv">$remote_user</span> <span class="s">[</span><span class="nv">$time_local]</span> <span class="s">&#39;</span>
                  <span class="s">&#39;&quot;</span><span class="nv">$request&quot;</span> <span class="nv">$status</span>  <span class="nv">$body_bytes_sent</span> <span class="s">&quot;</span><span class="nv">$http_referer&quot;</span> <span class="s">&#39;</span>
                  <span class="s">&#39;&quot;</span><span class="nv">$http_user_agent&quot;</span> <span class="s">&quot;</span><span class="nv">$http_x_forwarded_for&quot;&#39;</span><span class="p">;</span>

  <span class="c1"># main access log</span>
  <span class="kn">access_log</span>  <span class="s">/var/log/nginx_access.log</span>  <span class="s">main</span><span class="p">;</span>

  <span class="c1"># main error log</span>
  <span class="kn">error_log</span>  <span class="s">/var/log/nginx_error.log</span> <span class="s">debug</span><span class="p">;</span>

  <span class="c1"># no sendfile on OSX</span>
  <span class="kn">sendfile</span> <span class="no">on</span><span class="p">;</span>

  <span class="c1"># These are good default values.</span>
  <span class="kn">tcp_nopush</span>        <span class="no">on</span><span class="p">;</span>
  <span class="kn">tcp_nodelay</span>       <span class="no">off</span><span class="p">;</span>
  <span class="c1"># output compression saves bandwidth </span>
  <span class="kn">gzip</span>            <span class="no">on</span><span class="p">;</span>
  <span class="kn">gzip_http_version</span> <span class="mi">1</span><span class="s">.0</span><span class="p">;</span>
  <span class="kn">gzip_comp_level</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kn">gzip_proxied</span> <span class="s">any</span><span class="p">;</span>
  <span class="kn">gzip_types</span>      <span class="s">text/plain</span> <span class="s">text/html</span> <span class="s">text/css</span> <span class="s">application/x-javascript</span> <span class="s">text/xml</span> <span class="s">application/xml</span> <span class="s">application/xml+rss</span> <span class="s">text/javascript</span><span class="p">;</span>


  <span class="c1"># this is where you define your mongrel clusters. </span>
  <span class="c1"># you need one of these blocks for each cluster</span>
  <span class="c1"># and each one needs its own name to refer to it later.</span>
  <span class="kn">upstream</span> <span class="s">mongrel</span> <span class="p">{</span>
		<span class="kn">fair</span><span class="p">;</span> <span class="c1"># This changes from round-robin based to load based.</span>
    <span class="kn">server</span> <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">8000</span><span class="p">;</span>
    <span class="kn">server</span> <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">8001</span><span class="p">;</span>
    <span class="kn">server</span> <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">8002</span><span class="p">;</span>
  <span class="p">}</span>


  <span class="c1"># the server directive is nginx&#39;s virtual host directive.</span>
  <span class="kn">server</span> <span class="p">{</span>
    <span class="c1"># port to listen on. Can also be set to an IP:PORT</span>
    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
    
    <span class="c1"># Set the max size for file uploads to 50Mb</span>
    <span class="kn">client_max_body_size</span> <span class="s">50M</span><span class="p">;</span>

    <span class="c1"># sets the domain[s] that this vhost server requests for</span>
    <span class="c1"># server_name www.[yourdomain].com [yourdomain].com;</span>

    <span class="c1"># doc root</span>
    <span class="kn">root</span> <span class="s">/path/to/your/application/public</span><span class="p">;</span>

    <span class="c1"># vhost specific access log</span>
    <span class="kn">access_log</span>  <span class="s">/var/log/nginx.vhost.access.log</span>  <span class="s">main</span><span class="p">;</span>

    <span class="c1"># this rewrites all the requests to the maintenance.html</span>
    <span class="c1"># page if it exists in the doc root. This is for capistrano&#39;s</span>
    <span class="c1"># disable web task</span>
    <span class="kn">if</span> <span class="s">(-f</span> <span class="nv">$document_root/system/maintenance.html</span><span class="s">)</span> <span class="p">{</span>
      <span class="kn">rewrite</span>  <span class="s">^(.*)</span>$  <span class="s">/system/maintenance.html</span> <span class="s">last</span><span class="p">;</span>
      <span class="kn">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
      <span class="c1"># needed to forward user&#39;s IP address to rails</span>
      <span class="kn">proxy_set_header</span>  <span class="s">X-Real-IP</span>  <span class="nv">$remote_addr</span><span class="p">;</span>

      <span class="c1"># needed for HTTPS</span>
      <span class="kn">proxy_set_header</span>  <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
      <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
      <span class="kn">proxy_redirect</span> <span class="s">false</span><span class="p">;</span>
      <span class="kn">proxy_max_temp_file_size</span> <span class="mi">0</span><span class="p">;</span>
      
      <span class="c1"># If the file exists as a static file serve it directly without</span>
      <span class="c1"># running all the other rewite tests on it</span>
      <span class="kn">if</span> <span class="s">(-f</span> <span class="nv">$request_filename</span><span class="s">)</span> <span class="p">{</span> 
        <span class="kn">break</span><span class="p">;</span> 
      <span class="p">}</span>

      <span class="c1"># check for index.html for directory index</span>
      <span class="c1"># if its there on the filesystem then rewite </span>
      <span class="c1"># the url to add /index.html to the end of it</span>
      <span class="c1"># and then break to send it to the next config rules.</span>
      <span class="kn">if</span> <span class="s">(-f</span> <span class="nv">$request_filename/index.html</span><span class="s">)</span> <span class="p">{</span>
        <span class="kn">rewrite</span> <span class="s">(.*)</span> <span class="nv">$1/index.html</span> <span class="s">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1"># this is the meat of the rails page caching config</span>
      <span class="c1"># it adds .html to the end of the url and then checks</span>
      <span class="c1"># the filesystem for that file. If it exists, then we</span>
      <span class="c1"># rewite the url to have explicit .html on the end </span>
      <span class="c1"># and then send it on its way to the next config rule.</span>
      <span class="c1"># if there is no file on the fs then it sets all the </span>
      <span class="c1"># necessary headers and proxies to our upstream mongrels</span>
      <span class="kn">if</span> <span class="s">(-f</span> <span class="nv">$request_filename.html</span><span class="s">)</span> <span class="p">{</span>
        <span class="kn">rewrite</span> <span class="s">(.*)</span> <span class="nv">$1.html</span> <span class="s">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kn">if</span> <span class="s">(!-f</span> <span class="nv">$request_filename</span><span class="s">)</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span> <span class="s">http://mongrel</span><span class="p">;</span>
        <span class="kn">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kn">error_page</span>   <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span>  <span class="s">/500.html</span><span class="p">;</span>
    <span class="kn">location</span> <span class="p">=</span> <span class="s">/500.html</span> <span class="p">{</span>
      <span class="kn">root</span>   <span class="s">/path/to/your/application/public</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

Now that you have nginx configured, start it and you should have a solid rails stack up and running.

@# /etc/init.d/nginx start@

h2. Request Cycle

Unlike more traditional setups, each individual request does not necessarily take the same path. Nginx monitors port 80 and accepts all incoming requests. Using the rewrite rules it looks for a file in the @public@ directory with @/url/path + .html@. If it finds this static HTML page, it replies. It also searches for @index.html@ to retrieve folder indexes. These static HTML files are generated by rails' page caching mechanism, and provide enormous performance gains at a cost of flexibility. If nginx is unable to find an HTML page, it forwards the request to the cluster of mongrels. The mongrel that gets the request depends on which proxy algorithm you choose; the fair option spread the requests based on availability. Once received, the mongrel then runs the request through the rails application: the database is hit, ruby does some magic, and a page is completed and passed back to the mongrel which logs the request as complete and passes it back to nginx. If page caching is enabled, rails writes the page that was just generated to the @public@ directory (lazy caching) before handing it off to the mongrel. Nginx takes this page and forwards it to the browser, acting as a proxy (gateway). The general process is repeated on each request, but the mongrel that is given the dynamic request will be different, and a cached page may be found, avoiding the need to engage the mongrels all together.


</div>

<div class="paginator">
  
    <div class="previous">&larr; <a class="previous" href="/2008/03/21/traffic-jam-shockwave/" title="Previous post: Traffic Jam Shockwave">Traffic Jam Shockwave</a></div>
  
  
  
    <div class="next"><a class="next" href="/2008/04/04/glass-music/" title="Next post: Glass Music">Glass Music</a> &rarr;</div>
  
</div>


</div>
</body>
</html>